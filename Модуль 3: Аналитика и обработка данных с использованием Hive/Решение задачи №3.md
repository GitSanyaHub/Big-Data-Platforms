## 1. Установка и настройка Apache Hive

Переключимся в пользователя Hadoop:

```
sudo -i -u hadoop
```

Для начала перемещаемся на Junk ноду

Чтобы установить hive, нам надо сначала его скачать.
```
wget https://dlcdn.apache.org/hive/hive-4.0.1/apache-hive-4.0.1-bin.tar.gz
```

Развернем скачанный файл
```
tar -xzvf apache-hive-4.0.1-bin.tar.gz
```

Зайдем внутрь
```
cd apache-hive-4.0.1-bin
```
Установим заново hadoop:

- Откроем файл
```
hadoop@team-6-nn:~$ vim ~/.profile
```

- Сделаем вставку в конце файла и сохраним изменения
```
export HADOOP_HOME=/home/hadoop/hadoop-3.4.0
export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
export PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin
```

- Сделаем активацию новых переменных

```
hadoop@team-6-nn:~$ source ~/.profile
```

- Сделаем проверку, pезультат должен показать версию Hadoop
```
hadoop@team-6-nn:~$ hadoop version
```


Добавим в переменную окружения hive Home
```
export HIVE_HOME=/home/hadoop/apache-hive-4.0.1-bin
```
Добавим в общую переменную PATH
```
export PATH=$HIVE_HOME/bin:$PATH
```
Далее создадим конфигурационный файл и заново его заполним
```
vim conf/hive-site.xml
```
Для начала создадим папочки, с которым будет работать наш пользователь
```
hdfs dfs -ls /
cd ../hadoop-3.4.0/
export
hdfs dfs -ls
```
Подключимся для этого пока к нашей нейм ноде и создадим эти папочки:
```
ssh team-6-nn
hdfs dfs -ls
```
Создадим папочку и дадим некоторые права на нее и временную папку /tmp
```
hdfs dfs -mkdir -p /user/hive/warehouse
hdfs dfs -chmod g+w /tmp
hdfs dfs -chmod g+w /user/hive/warehouse
```
Перейдем обратно на junk ноду:
```
exit
```
Перейдем в папку 
```
cd ../apache-hive-4.0.1-bin/conf
```
Скопируем папочку hive-default.xml
```
ср hive-default.xml.template hive-site.xml 
```
Посмотрим какие папки есть в директории
```
ls -lh
```
Добавим property, который будет указывать, на папочку, в которой мы будем хранить данные Hive
```
vim hive-site.xml
```
<property>
<name>hive.metastore.warehouse.dir</name>
<value>/user/hive/warehouse</value>
<description›Defines the rewrite policy, the valid values are those defined in RewritePolicy enum‹ description> </property>


Скопируем папочку hive-default.xml
```
cp hive-env.sh.template hive-env.sh
```
Настроим окружение для Hive, добавим туда глобальные переменные и укажем нужную версию Java:
```
vim hive-env.sh
```

```
# export HADOOP_HOME=/home/hadoop/hadoop-3.4.0
# export JAVA_HOME=/us/lib/jvm/java-11-openjdk-amd64
export HIVE_HOME=/home/hadoop/apache-hive-4.0.1-bin
export HIVE_CONF
_DIR=SHIVE_HOME/conf
export HIVE_AUX_JARS_PATH=SHIVE_HOME/lib/*
```

Перейдем на нейм ноду
```
ssh tmpl-nn
```
Установим постгрес:
 ```
sudo apt install postgresql postgresql-contrib
```
Проверим, что он работает:
```
sudo systemctl status postgresql
```
Теперь переключимся в пользователя, чтобы создать базу данных:
```
sudo -i -u postgres
psql
```
Создадим базу данных и пользователя, с помощью которого HIVE будет подключаться к базе данных

```
CREATE DATABASE metastore ;
CREATE USER hive with password 'hive';
```

Дадим ему права на эту базу данных 
``` 
GRANT ALL PRIVILEGES ON DATABASE "metastore" to hive;
ALTER DATABASE metastore OWNER TO hive;
```

Выйдем из postgres:
```
\q
exit
```

Теперь мы для безопасности, должны разрешить подключение с определенных хостов. Нам нужно исправить определенный конфиг постгреса
```
vim /etc/postgresql/16/main/pg_hba.conf
```
Должно быть такое:
```
# IPv4 local connections:

host    all     all     127.0.0.1/32    scram-sha-256
host    all     all     192.168.1.2     trust
```

Рестартнем, чтобы новые конфиги применились
```
sudo systemctl restart postgresql
```
Проверим статус:
```
sudo systemctl status postgresql
```
Можем теперь вернуться в JN:
```
exit
```
Оказавшись здесь team@team-6-jn:
```
cd apache-hive-4.0.1-bin/conf/
source hive-env.sh
export
```
И добавим сюда драйвер для Postgres, чтоб наше приложение могло к нему подключаться. Установим его в эту папку:
```
cd /home/hadoop/apache-hive-4.0.1-bin/lib/
```
wget https://jdbc.postgresql.org/download/postgresql-42.7.4.jar

Драйвер есть, теперь нужно прописать к нему доступы
```
cd ../conf
vim hive-site.xml    
```
Нужно написать чет такое:
```
<property>
<name>javax. jdo.option. ConnectionURL</ name>
<value>jdbc: postgresql://192.168.1.3:5432/metastore</ value>
</ property> <property>
<name>javax. jdo.option.ConnectionDriverName</ name>
<value>org•postgresql.Driver</value>
</ property> <property>
<name>javax. jdo.option. ConnectionUserName</ name> <value>hive</value>
< property> <property>
<name>javax. jdo.option.ConnectionPassword</ name>
<value>hive</value>
< property>
</ configuration>
```
Перейдем:
```
cd ../
```
Дальше можем обратиться к базе данных:

hadoop@tmpl-jn:~/apache-hive-4.0.1-bin$ bin/schematool -dbType postgresql -initschema
